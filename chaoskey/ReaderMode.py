# -*- coding: utf-8 -*-# 我的Anki插件# 作者：混沌(youliang@chaoskey.com), http://blog.chaoskey.com# 阅读模式from aqt import mwfrom aqt.qt import *from comm import onLoad,onSwitch,wrap,studyMode,readModeoldOverviewTable=mw.overview._table# 为Overview的界面增加一个“现在阅读”的按钮def newOverviewTable():    counts = list(mw.col.sched.counts())    finished = not sum(counts)    for n in range(len(counts)):        if counts[n] == 1000:            counts[n] = "1000+"    but = mw.button    readButs="" if mw.col.conf.get('taskdid')==mw.col.decks.current().get("id") else u"""<b>按状态阅读</b><br /><table width=300 cellpadding=5>    <tr align=center><td>%s</td><td>%s</td><td>%s</td></tr>    <tr align=center><td>%s</td><td>%s</td><td>%s</td></tr></table><br />    """%(but("read_review", _("Review"), id="read_review"),        but("read_marked", _("Marked"), id="read_marked"),        but("read_leech", _("Leech"), id="read_leech"),        but("read_added", _("Added Today"), id="read_added"),        but("read_rated", _("Studied Today"), id="read_rated"),        but("read_rated2", _("Again Today"), id="read_rated2"))    if finished:        return '%s<br />%s<br /><div style="white-space: pre-wrap;">%s</div>' % (            but("read","<font color='green'><b>"+_("Read Now")+"</b></font>", id="read"),            readButs,            mw.col.sched.finishedMsg())    else:        return '''<table width=300 cellpadding=5>    <tr>        <td align=center valign=top>            <table cellspacing=5>                <tr><td>%s:</td><td><b><font color=#00a>%s</font></b></td><td>%s</td></tr>                <tr><td>%s:</td><td><b><font color=#C35617>%s</font></b></td><td>%s</td></tr>                <tr><td>%s:</td><td><b><font color=#0a0>%s</font></b></td><td>%s</td></tr>            </table>        </td>        <td align=center>            <table cellspacing=5>                <tr><td>%s</td></tr>                <tr><td>%s</td></tr>            </table>        </td>    </tr></table><br />%s''' % (    _("New"), counts[0],(but("read_new_%s"%counts[0], _("Preview"), id="read_new_%s"%counts[0]) if counts[0]>0 else ""),    _("Learning"), counts[1],(but("read_learn_%s"%counts[1], _("Preview"), id="read_learn_%s"%counts[1]) if counts[1]>0 else ""),    _("To Review"), counts[2],(but("read_due_%s"%counts[2], _("Preview"), id="read_due_%s"%counts[2]) if counts[2]>0 else ""),    but("study", "<font color='red'><b>"+_("Study Now")+"</b></font>", id="study"),    but("read", "<font color='green'><b>"+_("Read Now")+"</b></font>", id="read"),    readButs)oldOverviewLinkHandler=mw.overview._linkHandler# 学习模式与阅读模式的切换def newOverviewLinkHandler(_old,url):    global studyMode,readMode    if url == "study":        mw.reviewer=studyMode        mw.col.startTimebox()        mw.moveToState("review")    elif url.startswith("read"):        readMode.readType="all"        readMode.readLimit=-1        if url.startswith("read_"):            url=url[5:].split("_")            readMode.readType=url[0]            if len(url)>1:                readMode.readLimit=int(url[1])        mw.reviewer=readMode        mw.col.startTimebox()        mw.moveToState("review")    else:        _old(url)def load():    mw.overview._table = newOverviewTable    mw.overview._linkHandler = wrap(mw.overview._linkHandler, newOverviewLinkHandler,pos="replace")def unload():    mw.overview._table=oldOverviewTable    mw.overview._linkHandler=oldOverviewLinkHandler################################################################# 本模块的信息ModuleInfo = {'name': u'阅读模式'}plugName=os.path.basename(__file__).replace(".py", "")# 添加功能开关action=QAction(ModuleInfo["name"], mw)action.setCheckable(True)action.connect(action, SIGNAL("triggered()"),lambda:onSwitch(load,unload,action,plugName))ModuleInfo.update({"action":action})# 功能加载onLoad(load,action,plugName)